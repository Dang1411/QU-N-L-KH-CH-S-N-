CREATE DATABASE QUANLI_KHACHSAN_BTL
USE QUANLI_KHACHSAN_BTL
/* - THỨ TỰ CHÈN CÁC BẢNG VÀO CƠ SỞ DỮ LIỆU 
NHANVIEN (MANHANVIEN, MATKHAU, HOTEN, NGAYSINH, GIOITINH, DIACHI, SODIENTHOAI, NGAYVAOLAM, ANH)

LOAIPHONG (MALOAIPHONG, LOAIPHONG, GIATIEN)

DANHMUCPHONG (MAPHONG, MALOAIPHONG, TANG, TINHTRANG, ANHPHONG)

KHACHHANG (MAKHACHHANG, HOTEN, GIOITINH, DIACHI, CMND, DIENTHOAI)

THUEPHONG (SHDTHUEPHONG, MANHANVIEN, MAPHONG, NGAYTHUE, NGAYTRA)

CHITIETTHUEPHONG (SHDTHUEPHONG, MAKHACHHANG)

HDTHANHTOANPHONG (SHDTHANHTOAN, SHDTHUEPHONG, MANHANVIEN, NGAYTHANHTOAN, TIENPHONG)

THIETBI_DICHVU (MATHIETBI, TENTHIETBI, DONVITINH, GIATIEN)

SUDUNGDICHVU (SHDTHUEPHONG, MATHIETBI, NGAYSUDUNG, SOLUONG)

THIETBI_PHONG (MALOAIPHONG, MATHIETBI, SOLUONG)

-*/ 
/*--------------TẠO BẢNG NHÂN VIÊN---------------*/
CREATE TABLE NHANVIEN (
    MANHANVIEN NVARCHAR(20) NOT NULL PRIMARY KEY,
    MATKHAU VARCHAR(20) NOT NULL,
    HOTEN NVARCHAR(100) NOT NULL,
    NGAYSINH DATE NOT NULL,
    GIOITINH BIT NOT NULL,
    DIACHI NVARCHAR(100) NOT NULL,
    SODIENTHOAI VARCHAR(20),
    NGAYVAOLAM DATE NOT NULL,
    ANH NVARCHAR(100)
);
INSERT INTO NHANVIEN (MANHANVIEN, MATKHAU, HOTEN, NGAYSINH, GIOITINH, DIACHI, SODIENTHOAI, NGAYVAOLAM,ANH)  
VALUES  
    ('NV001', 'UTC@123', N'Từ Quốc Chung', '2004-03-01', 1, N'Quận Đống Đa-Hà Nội', '0973287666', '2024-09-11','mot.jpg'),
    ('NV002', 'UTC@123', N'Võ Hoàng Hưng', '2004-01-01', 1, N'Quận Thanh Trì-Hà Nội', '0972873536', '2024-11-11','hai.jpg'),
    ('NV003', 'UTC@123', N'Võ Hồng Thịnh', '2004-10-05', 1, N'Quận Hoàn Kiếm-Hà Nội', '0273347611', '2024-01-11','ba.jpg'),
    ('NV004', 'UTC@123', N'Phạm Nguyễn Hồng Phong', '2004-02-03', 1, N'Quận Nam Từ Liêm- Hà Nội', '0273287666', '2024-02-11','bon.jpg'),
    ('NV005', 'UTC@123', N'Nguyễn Hồng Đăng', '2001-02-01', 1, N'Quận Cầu Giấy- Hà Nội', '0973287999', '2023-12-11','nam.jpg');

/*--------------TẠO BẢNG LOAIPHONG---------------*/
CREATE TABLE LOAIPHONG(
MALOAIPHONG NVARCHAR(20) NOT NULL PRIMARY KEY,
LOAIPHONG NVARCHAR(50) NOT NULL,
GIATIEN MONEY NOT NULL,
);
INSERT INTO LOAIPHONG
VALUES 
('MLP01',N'Phòng vip',50),
('MLP02',N'Phòng tầm trung',30),
('MLP03',N'Phòng thường',10);


/*--------------TẠO BẢNG DANHMUCPHONG---------------*/
CREATE TABLE DANHMUCPHONG
(
MAPHONG NVARCHAR(20) NOT NULL PRIMARY KEY,
MALOAIPHONG NVARCHAR(20) NOT NULL,
TANG INT NOT NULL,
TINHTRANG BIT NOT NULL,
ANHPHONG NVARCHAR(50),
CONSTRAINT KN_DMPHONG FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG),
);
/* - 1 thì đã có người thuê , 0 thì chưa có người thuê - */ 
INSERT INTO DANHMUCPHONG (MAPHONG, MALOAIPHONG, TANG, TINHTRANG, ANHPHONG)
VALUES
('MP01', 'MLP01', 1, 1, 'mot.jpg'),
('MP02', 'MLP01', 2, 1, 'hai.jpg'),
('MP03', 'MLP01', 3, 1, 'ba.jpg'),
('MP04', 'MLP01', 4, 1, 'bon.jpg'),
('MP05', 'MLP01', 5, 1, 'nam.jpg'),
('MP06', 'MLP02', 6, 1, 'sau.jpg'),
('MP07', 'MLP02', 7, 1, 'bay.jpg'),
('MP08', 'MLP02', 8, 1, 'tam.jpg'),
('MP09', 'MLP02', 9, 1, 'chin.jpg'),
('MP10', 'MLP02', 10, 1, 'muoi.jpg'),
('MP11', 'MLP03', 1, 1, 'muoimot.jpg'),
('MP12', 'MLP03', 2, 1, 'muoihai.jpg'),
('MP13', 'MLP03', 3, 1, 'muoiba.jpg'),
('MP14', 'MLP03', 4, 1, 'muoibon.jpg'),
('MP15', 'MLP03', 5, 0, 'muoinam.jpg'),
('MP16', 'MLP03', 5, 0, 'muoisau.jpg'),
('MP17', 'MLP03', 6, 0, 'muoibay.jpg'),
('MP18', 'MLP03', 7, 0, 'muoitam.jpg'),
('MP19', 'MLP03', 8, 0, 'muoichin.jpg');

/*--------------TẠO BẢNG KHACHHANG---------------*/
CREATE TABLE KHACHHANG(
MAKHACHHANG NVARCHAR(20) NOT NULL PRIMARY KEY,
HOTEN NVARCHAR(100) NOT NULL,
GIOITINH BIT,
DIACHI NVARCHAR(255),
CMND NVARCHAR(20),
DIENTHOAI VARCHAR(15),
);
INSERT INTO KHACHHANG
VALUES
('KH01',N'Lê Đức Sơn',1,N'Đà Nẵng','030301009999','0987654678'),
('KH02',N'Nguyễn Thị Hoa ',0,N'Đà Lạt','0303010000','0987654999'),
('KH03',N'Trần Vũ Anh ',1,N'Hà Nội','030301066666','09876543677'),
('KH04',N'Trần Thanh Hoa ',0,N'Hồ Chí Minh','03030999992','09876543365'),
('KH05',N'Hoàng Thị Thúy ',0,N'Hải Phòng','030309999999','0987654666'),
('KH06',N'Vũ Trọng Kiên',1,N'Hải Phòng','0303010122344','0987654323'),
('KH07',N'Lê Văn Đô ',1,N'Hà Nội','003987654333','0987654777'),
('KH08',N'Nguyễn Hồng',0,N'Hà Nam','0303023231221','0987654314'),
('KH09',N'Hoàng Sơn ',1,N'Đà Nẵng','03030323115657','0987654133'),
('KH10',N'Trần Thanh Nhàn ',0,N'Đà Nẵng','030301023254643','0987654333'),
('KH11',N'Hoàng Sơn Tùng ',1,N'Đà Nẵng','03030323115657','0987654133'),
('KH12',N'Hoàng Thùy Linh ',1,N'Đà Lạt','03030233115222','0987654133'),
('KH13',N'Vũ Tiến Đạt ',1,N'Đà Nẵng','03030323115657','0987654111'),
('KH14',N'Hoàng Sơn Đạt ',1,N'Hà Nội','0303032311527','0987654100'),
('KH15', N'Nguyễn Văn Hùng', 1, N'Hà Nội', '030301045678', '0987654001'),
('KH16', N'Trần Thị Lan', 0, N'Quảng Ninh', '030301234567', '0987654002'),
('KH17', N'Phạm Minh Tuấn', 1, N'Bình Dương', '030301876543', '0987654003'),
('KH18', N'Võ Thị Xuân', 0, N'Nha Trang', '030301556677', '0987654004'),
('KH19', N'Lê Hoài Nam', 1, N'Hà Nội', '030301998877', '0987654005'),
('KH20', N'Nguyễn Phúc Thịnh', 1, N'Hải Dương', '030301332211', '0987654006'),
('KH21', N'Tran Anh Quoc', 1, N'Saigon', '030301009876', '0987654007')


/*--------------TẠO BẢNG THUEPHONG---------------*/
CREATE TABLE THUEPHONG (
    SHDTHUEPHONG NVARCHAR(20) PRIMARY KEY,
    MANHANVIEN NVARCHAR(20) NOT NULL,
    MAPHONG NVARCHAR(20) NOT NULL,
    NGAYTHUE DATETIME NOT NULL,
    NGAYTRA DATETIME NOT NULL,
    CONSTRAINT KN_THUEPHONG_MANHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN),
    CONSTRAINT KN_THUEPHONG_MAPHONG FOREIGN KEY (MAPHONG) REFERENCES DANHMUCPHONG(MAPHONG)
);
INSERT INTO THUEPHONG(SHDTHUEPHONG, MANHANVIEN, MAPHONG, NGAYTHUE, NGAYTRA)
VALUES
    ('THP001', 'NV001', 'MP01', '2024-12-10 14:00:00', '2025-01-01 10:00:00'),    => 400 + 50 * 21 = 
    ('THP002', 'NV002', 'MP02', '2024-11-24 15:30:00', '2025-01-09 09:45:00'),
    ('THP003', 'NV003', 'MP03', '2024-11-24 12:00:00', '2025-11-01 08:30:00'),
    ('THP004', 'NV004', 'MP04', '2024-11-25 16:15:00', '2025-01-02 11:00:00'),
    ('THP005', 'NV003', 'MP05', '2024-11-26 13:00:00', '2024-12-26 10:00:00'),
    ('THP006', 'NV002', 'MP06', '2024-12-22 14:30:00', '2025-01-01 09:30:00'),
    ('THP007', 'NV001', 'MP07', '2024-12-23 18:00:00', '2025-01-23 11:45:00'),
    ('THP008', 'NV001', 'MP08', '2024-12-23 20:00:00', '2025-01-23 12:30:00'),
    ('THP009', 'NV004', 'MP09', '2024-12-23 13:45:00', '2025-01-23 08:15:00'),
    ('THP010', 'NV001', 'MP10', '2024-12-24 17:00:00', '2025-01-24 13:30:00'),
    ('THP011', 'NV002', 'MP11', '2024-12-24 15:00:00', '2025-01-24 09:00:00'),
    ('THP012', 'NV003', 'MP12', '2024-12-25 10:00:00', '2025-01-25 11:00:00'),
    ('THP013', 'NV004', 'MP13', '2024-12-25 14:15:00', '2025-01-25 10:45:00'),
    ('THP014', 'NV005', 'MP14', '2024-12-26 09:30:00', '2025-01-26 10:00:00');


-- Tạo bảng CHITIETTHUEPHONG và thêm dữ liệu
CREATE TABLE CHITIETTHUEPHONG (
    SHDTHUEPHONG NVARCHAR(20) NOT NULL,
    MAKHACHHANG NVARCHAR(20) NOT NULL,
    CONSTRAINT PK_CHITIETTHUEPHONG PRIMARY KEY (SHDTHUEPHONG, MAKHACHHANG),
    CONSTRAINT FK_CHITIETTHUEPHONG_SHDTHUEPHONG FOREIGN KEY (SHDTHUEPHONG) REFERENCES THUEPHONG(SHDTHUEPHONG),
    CONSTRAINT FK_CHITIETTHUEPHONG_MAKHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG)
);

-- Chèn dữ liệu vào bảng CHITIETTHUEPHONG
INSERT INTO CHITIETTHUEPHONG (SHDTHUEPHONG, MAKHACHHANG)
VALUES
    ('THP001', 'KH02'),
    ('THP002', 'KH03'),
    ('THP002', 'KH04'),
    ('THP003', 'KH05'),
    ('THP003', 'KH06'),
    ('THP004', 'KH07'),
    ('THP004', 'KH08'),
    ('THP005', 'KH09'),
    ('THP005', 'KH10'),
    ('THP006', 'KH11'),
    ('THP006', 'KH12'),
    ('THP007', 'KH13'),
    ('THP007', 'KH14'),
    ('THP008', 'KH15'),
    ('THP009', 'KH16'),
    ('THP010', 'KH17'),
    ('THP011', 'KH18'),
    ('THP012', 'KH19'),
    ('THP013', 'KH20'),
	('THP014', 'KH21');
-- Tạo bảng HDTHANHTOANPHONG và thêm dữ liệu
CREATE TABLE HDTHANHTOANPHONG (
    SHDTHANHTOAN NVARCHAR(20) PRIMARY KEY,
    SHDTHUEPHONG NVARCHAR(20) NOT NULL,
    MANHANVIEN NVARCHAR(20) NOT NULL,
    NGAYTHANHTOAN DATETIME NOT NULL,
    TIENPHONG MONEY NOT NULL,
    CONSTRAINT FK_HDTHANHTOANPHONG_SHDTHUEPHONG FOREIGN KEY (SHDTHUEPHONG) REFERENCES THUEPHONG(SHDTHUEPHONG),
    CONSTRAINT FK_HDTHANHTOANPHONG_MANHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
);
INSERT INTO HDTHANHTOANPHONG (SHDTHANHTOAN, SHDTHUEPHONG, MANHANVIEN, NGAYTHANHTOAN, TIENPHONG)
VALUES
    ('HDTP001', 'THP001', 'NV001', '2025-01-01 11:00:00', 0),
    ('HDTP002', 'THP002', 'NV002', '2025-01-09 10:00:00',0),
    ('HDTP003', 'THP003', 'NV003', '2025-11-01 09:00:00',0),
    ('HDTP004', 'THP004', 'NV004', '2025-01-02 12:00:00',0),
    ('HDTP005', 'THP006', 'NV001', '2025-01-01 10:30:00', 0),
    ('HDTP006', 'THP007', 'NV001', '2025-01-23 12:00:00', 0),
    ('HDTP007', 'THP008', 'NV002', '2025-01-23 13:00:00',0),
    ('HDTP008', 'THP009', 'NV003', '2025-01-23 09:00:00', 0),
    ('HDTP009', 'THP010', 'NV004', '2025-01-24 14:00:00', 0),
    ('HDTP010', 'THP011', 'NV001', '2025-01-24 10:30:00',0);
/*--------------TẠO BẢNG THIETBI_DICHVU---------------*/
CREATE TABLE THIETBI_DICHVU
(
MATHIETBI NVARCHAR(20) NOT NULL PRIMARY KEY,
TENTHIETBI NVARCHAR(50) NOT NULL,
DONVITINH NVARCHAR(10),
GIATIEN MONEY NOT NULL,
);
INSERT INTO THIETBI_DICHVU
VALUES
('MTB01',N'Điều hòa',N'chiếc',400),
('MTB02',N'Tivi',N'chiếc',300),
('MTB03',N'Giường',N'chiếc',100),
('MTB04',N'Máy chơi game',N'chiếc',10),
('MTB05',N'Bình nóng lạnh',N'chiếc',500),
('MTB06',N'Đèn điện',N'chiếc',10),
('MTB07',N'Bàn',N'chiếc',20),
('MTB08',N'Ghế',N'chiếc',10),
('MTB09', N'Tủ lạnh', N'chiếc', 600),
('MTB10', N'Lò vi sóng', N'chiếc', 150),
('MTB11', N'Bếp điện', N'chiếc', 200),
('MTB12', N'Máy hút bụi', N'chiếc', 100),
('MTB13', N'Máy sấy tóc', N'chiếc', 30),
('MTB14', N'Máy lọc không khí', N'chiếc', 250),
('MTB15', N'Máy pha cà phê', N'chiếc', 120),
('MTB16', N'Máy giặt', N'chiếc', 700),
('MTB17', N'Máy rửa chén', N'chiếc', 800),
('MTB18', N'Bình nước nóng', N'chiếc', 180);

/*--------------TẠO BẢNG SUDUNGDICHVU---------------*/
CREATE TABLE SUDUNGDICHVU
(
    SHDTHUEPHONG NVARCHAR(20) NOT NULL,
    MATHIETBI NVARCHAR(20) NOT NULL,
    NGAYSUDUNG DATE,
    SOLUONG INT,
    CONSTRAINT KC_SUDUNGDV PRIMARY KEY (SHDTHUEPHONG, MATHIETBI, NGAYSUDUNG),
    CONSTRAINT KN_SUDUNGDV_SHDTHUEPHONG FOREIGN KEY (SHDTHUEPHONG) REFERENCES THUEPHONG(SHDTHUEPHONG),
    CONSTRAINT KN_SUDUNGDV_MATHIETBI FOREIGN KEY (MATHIETBI) REFERENCES THIETBI_DICHVU(MATHIETBI)
);
INSERT INTO SUDUNGDICHVU (SHDTHUEPHONG, MATHIETBI, NGAYSUDUNG, SOLUONG)
VALUES 
    ('THP001', 'MTB04', '2025-11-11', 1),
    ('THP002', 'MTB01', '2025-11-11', 1),
    ('THP001', 'MTB04', '2025-12-11', 1),
    ('THP003', 'MTB04', '2024-12-12', 1),
    ('THP004', 'MTB03', '2024-12-12', 1),
    ('THP005', 'MTB04', '2025-11-29', 1),
    ('THP006', 'MTB06', '2025-11-12', 1),
    ('THP001', 'MTB05', '2025-11-12', 1);

--TẠO BẢNG THIETBI_PHONG
CREATE TABLE THIETBI_PHONG
(
    MALOAIPHONG NVARCHAR(20) NOT NULL,
    MATHIETBI NVARCHAR(20) NOT NULL,
    SOLUONG INT NOT NULL,
    CONSTRAINT KC_THIETBI_PHONG PRIMARY KEY (MALOAIPHONG, MATHIETBI),
    CONSTRAINT KN_THIETBI_PHONG_MALOAIPHONG FOREIGN KEY (MALOAIPHONG) REFERENCES LOAIPHONG(MALOAIPHONG),
    CONSTRAINT KN_THIETBI_PHONG_MATHIETBI FOREIGN KEY (MATHIETBI) REFERENCES THIETBI_DICHVU(MATHIETBI)
);

-- CHÈN DỮ LIỆU VÀO BẢNG THIETBI_PHONG
INSERT INTO THIETBI_PHONG (MALOAIPHONG, MATHIETBI, SOLUONG)
VALUES
    ('MLP01', 'MTB01', 2),
    ('MLP01', 'MTB02', 1),
    ('MLP01', 'MTB03', 1),
    ('MLP01', 'MTB04', 1),
	('MLP01', 'MTB05', 1),
	('MLP01', 'MTB06', 1),
	('MLP01', 'MTB07', 1),
	('MLP01', 'MTB08', 1),
    ('MLP02', 'MTB01', 2),
    ('MLP02', 'MTB02', 1),
    ('MLP02', 'MTB03', 1),
    ('MLP02', 'MTB04', 1),
	('MLP02', 'MTB05', 1),
	('MLP02', 'MTB06', 1),
	('MLP02', 'MTB07', 1),
	('MLP02', 'MTB08', 1),
    ('MLP03', 'MTB01', 2),
    ('MLP03', 'MTB02', 1),
    ('MLP03', 'MTB03', 1),
    ('MLP03', 'MTB04', 1),
	('MLP03', 'MTB05', 1),
	('MLP03', 'MTB06', 1),
	('MLP03', 'MTB07', 1),
	('MLP03', 'MTB08', 1)



=======================================================================
CREATE FUNCTION dbo.TINHSONGAYTHUE (
    @SHDThuePhong NVARCHAR(20)
)
RETURNS INT
AS
BEGIN
    DECLARE @SoNgayThue INT;

    SELECT @SoNgayThue = DATEDIFF(DAY, tp.NGAYTHUE, tp.NGAYTRA)
    FROM THUEPHONG AS tp
    WHERE tp.SHDTHUEPHONG = @SHDThuePhong;

    RETURN @SoNgayThue;
END;


CREATE FUNCTION dbo.TINHTIENPHONG (
    @SHDThuePhong NVARCHAR(20)
)
RETURNS MONEY
AS
BEGIN
    DECLARE @GiaTienPhong MONEY = 0;
    DECLARE @SoNgayThue INT = dbo.TINHSONGAYTHUE(@SHDThuePhong);

    SELECT @GiaTienPhong = lp.GIATIEN
    FROM THUEPHONG AS tp
    JOIN DANHMUCPHONG dp ON tp.MAPHONG = dp.MAPHONG
    JOIN LOAIPHONG lp ON dp.MALOAIPHONG = lp.MALOAIPHONG
    WHERE tp.SHDTHUEPHONG = @SHDThuePhong;

    RETURN @SoNgayThue * @GiaTienPhong;
END;


CREATE FUNCTION dbo.TINHTIENDICHVU (
    @SHDThuePhong NVARCHAR(20)
)
RETURNS MONEY
AS
BEGIN
    DECLARE @TongTienDichVu MONEY = 0;

    SELECT @TongTienDichVu = SUM(sd.SOLUONG * tb.GIATIEN)
    FROM SUDUNGDICHVU sd
    JOIN THIETBI_DICHVU tb ON sd.MATHIETBI = tb.MATHIETBI
    WHERE sd.SHDTHUEPHONG = @SHDThuePhong;

    RETURN @TongTienDichVu;
END;

ALTER FUNCTION dbo.TINHTIENHOADON (
    @SHDThuePhong NVARCHAR(20)
)
RETURNS MONEY
AS
BEGIN
    DECLARE @TongTienPhong MONEY;
    DECLARE @TongTienDichVu MONEY;

    SET @TongTienPhong = dbo.TINHTIENPHONG(@SHDThuePhong);
    SET @TongTienDichVu = dbo.TINHTIENDICHVU(@SHDThuePhong);

    RETURN @TongTienPhong + @TongTienDichVu;
END;

SELECT dbo.TINHTIENHOADON('THP001')



SELECT 
    tp.NGAYTHUE, 
    tp.NGAYTRA, 
    DATEDIFF(DAY, tp.NGAYTHUE, tp.NGAYTRA) AS SoNgayThue, 
    lp.GIATIEN AS GiaPhong, 
    ISNULL(SUM(sd.SOLUONG * tb.GIATIEN), 0) AS GiaDichVu,
    nv.HOTEN AS HoTen,
    (DATEDIFF(DAY, tp.NGAYTHUE, tp.NGAYTRA) * lp.GIATIEN + ISNULL(SUM(sd.SOLUONG * tb.GIATIEN), 0)) AS TongTien
FROM THUEPHONG tp
INNER JOIN DANHMUCPHONG dp ON tp.MAPHONG = dp.MAPHONG
INNER JOIN LOAIPHONG lp ON dp.MALOAIPHONG = lp.MALOAIPHONG
LEFT JOIN SUDUNGDICHVU sd ON tp.SHDTHUEPHONG = sd.SHDTHUEPHONG
LEFT JOIN THIETBI_DICHVU tb ON sd.MATHIETBI = tb.MATHIETBI
LEFT JOIN NHANVIEN nv ON tp.MANHANVIEN = nv.MANHANVIEN
WHERE tp.SHDTHUEPHONG = 'THP001'
GROUP BY tp.NGAYTHUE, tp.NGAYTRA, lp.GIATIEN, nv.HOTEN;
